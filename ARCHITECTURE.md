# üèóÔ∏è Arquitetura do Sistema - Multi-Tenancy com RBAC e ABAC

## üìä Modelo de Dados

### Estrutura de Relacionamentos

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     MULTI-TENANCY ARCHITECTURE                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  TENANT  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ USERS_TENANTS_ROLES ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   USER   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                        ‚îÇ
     ‚îÇ 1:N                    ‚îÇ N:1
     ‚îÇ                        ‚îÇ
     ‚Üì                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ROLE   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇPERMISSION‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   N:N        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚îÇ N:1
                               ‚Üì
                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                          ‚îÇ  POLICY  ‚îÇ
                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîë Entidades Principais

### 1. **Tenant** (Organiza√ß√£o)
- **Descri√ß√£o**: Representa uma organiza√ß√£o/empresa no sistema
- **Caracter√≠sticas**:
  - Cada tenant √© isolado dos demais
  - Pode ter m√∫ltiplas roles espec√≠ficas
  - Configura√ß√£o personaliz√°vel via JSON

**Campos:**
- `id` (UUID) - Identificador √∫nico
- `name` (String) - Nome √∫nico do tenant
- `config` (JSONB) - Configura√ß√µes personalizadas
- `roles` (Set<Role>) - Roles pertencentes a este tenant
- `created_at`, `updated_at` - Timestamps

### 2. **Role** (Papel/Fun√ß√£o)
- **Descri√ß√£o**: Define um papel dentro de um tenant
- **Caracter√≠sticas**:
  - Pertence a um tenant espec√≠fico
  - Cont√©m m√∫ltiplas permissions
  - Nome √∫nico por tenant (pode repetir entre tenants diferentes)

**Campos:**
- `id` (UUID) - Identificador √∫nico
- `name` (String) - Nome do role (ex: "ADMIN", "MANAGER")
- `description` (String) - Descri√ß√£o opcional
- `tenant` (Tenant) - Tenant propriet√°rio
- `permissions` (Set<Permission>) - Permissions associadas

**Relacionamentos:**
- `N:1` com `Tenant` - Cada role pertence a um tenant
- `N:N` com `Permission` - Um role tem v√°rias permissions

### 3. **Permission** (Permiss√£o)
- **Descri√ß√£o**: Define uma a√ß√£o espec√≠fica em um recurso
- **Caracter√≠sticas**:
  - Combina√ß√£o √∫nica de `action` + `resource`
  - Pode ter uma policy ABAC associada
  - Compartilhada entre m√∫ltiplos roles

**Campos:**
- `id` (UUID) - Identificador √∫nico
- `action` (String) - A√ß√£o (ex: "create", "read", "update", "delete")
- `resource` (String) - Recurso (ex: "users", "articles", "reports")
- `policy` (Policy) - Policy ABAC opcional
- `roles` (Set<Role>) - Roles que possuem esta permission

**Relacionamentos:**
- `N:N` com `Role` - V√°rias permissions para v√°rios roles
- `N:1` com `Policy` - Cada permission pode ter uma policy

### 4. **Policy** (Pol√≠tica ABAC)
- **Descri√ß√£o**: Define regras de acesso baseadas em atributos
- **Caracter√≠sticas**:
  - Permite/nega acesso baseado em condi√ß√µes
  - Suporta m√∫ltiplas actions e resources
  - Condi√ß√µes flex√≠veis em JSON

**Campos:**
- `id` (UUID) - Identificador √∫nico
- `name` (String) - Nome √∫nico da policy
- `description` (String) - Descri√ß√£o opcional
- `effect` (Enum) - "ALLOW" ou "DENY"
- `actions` (Array<String>) - Lista de a√ß√µes
- `resources` (Array<String>) - Lista de recursos
- `conditions` (JSONB) - Condi√ß√µes ABAC em JSON
- `permissions` (Set<Permission>) - Permissions usando esta policy

**Exemplo de Condi√ß√µes:**
```json
{
  "ip_range": ["192.168.1.0/24"],
  "time_of_day": {"start": "08:00", "end": "18:00"},
  "user_department": "engineering",
  "resource_owner": "${user.id}"
}
```

### 5. **User** (Usu√°rio)
- **Descri√ß√£o**: Usu√°rio do sistema
- **Caracter√≠sticas**:
  - Pode participar de m√∫ltiplos tenants
  - Pode ter diferentes roles em cada tenant
  - Email √∫nico global

**Campos:**
- `id` (UUID) - Identificador √∫nico
- `name` (String) - Nome completo
- `email` (String) - Email √∫nico
- `password_hash` (String) - Senha criptografada
- `is_active` (Boolean) - Status do usu√°rio
- `tenantRoles` (Set<UsersTenantsRoles>) - Relacionamentos tenant-role

### 6. **UsersTenantsRoles** (Tabela de Jun√ß√£o)
- **Descri√ß√£o**: Relaciona usu√°rios com tenants e roles
- **Caracter√≠sticas**:
  - Chave prim√°ria composta (user_id, tenant_id, role_id)
  - Permite que um usu√°rio tenha m√∫ltiplos roles em um tenant
  - Permite que um usu√°rio participe de m√∫ltiplos tenants

**Campos:**
- `user_id` (UUID) - ID do usu√°rio
- `tenant_id` (UUID) - ID do tenant
- `role_id` (UUID) - ID do role

## üéØ Fluxo de Autoriza√ß√£o

### Exemplo Pr√°tico

**Cen√°rio:** Jo√£o precisa criar um artigo

```
1. Jo√£o faz login
   ‚îî‚îÄ> Sistema identifica User (Jo√£o)

2. Sistema verifica contexto atual
   ‚îî‚îÄ> Tenant: "Empresa ABC"
   ‚îî‚îÄ> User ID: uuid-joao

3. Busca roles de Jo√£o no tenant "Empresa ABC"
   ‚îî‚îÄ> Consulta: UsersTenantsRoles
   ‚îî‚îÄ> Resultado: Role "EDITOR"

4. Busca permissions do role "EDITOR"
   ‚îî‚îÄ> Consulta: Role.permissions
   ‚îî‚îÄ> Resultado: Permission(action="create", resource="articles")

5. Verifica se permission tem policy associada
   ‚îî‚îÄ> Consulta: Permission.policy
   ‚îî‚îÄ> Resultado: Policy "Editor Articles Policy"

6. Avalia condi√ß√µes da policy
   ‚îî‚îÄ> Verifica: IP, hor√°rio, departamento, etc.
   ‚îî‚îÄ> Resultado: ALLOW

7. Autoriza a a√ß√£o
   ‚îî‚îÄ> Jo√£o pode criar artigos
```

## üìã Exemplos de Uso

### Exemplo 1: Criar Tenant com Roles

```java
// 1. Criar tenant
Tenant tenant = Tenant.createNew("Empresa XYZ", config);
tenantRepository.save(tenant);

// 2. Criar roles para o tenant
Role adminRole = Role.createNew("ADMIN", "Administrador", tenant);
Role editorRole = Role.createNew("EDITOR", "Editor", tenant);
Role viewerRole = Role.createNew("VIEWER", "Visualizador", tenant);

roleRepository.saveAll(List.of(adminRole, editorRole, viewerRole));

// 3. Criar permissions
Permission createArticles = Permission.createNew("create", "articles");
Permission readArticles = Permission.createNew("read", "articles");
Permission updateArticles = Permission.createNew("update", "articles");
Permission deleteArticles = Permission.createNew("delete", "articles");

permissionRepository.saveAll(List.of(createArticles, readArticles, updateArticles, deleteArticles));

// 4. Associar permissions aos roles
adminRole.addPermission(createArticles);
adminRole.addPermission(readArticles);
adminRole.addPermission(updateArticles);
adminRole.addPermission(deleteArticles);

editorRole.addPermission(createArticles);
editorRole.addPermission(readArticles);
editorRole.addPermission(updateArticles);

viewerRole.addPermission(readArticles);

roleRepository.saveAll(List.of(adminRole, editorRole, viewerRole));
```

### Exemplo 2: Associar Usu√°rio a Tenant com Role

```java
// 1. Buscar entidades
User user = userRepository.findByEmail("joao@email.com");
Tenant tenant = tenantRepository.findByName("Empresa XYZ");
Role role = roleRepository.findByNameAndTenant("EDITOR", tenant);

// 2. Criar relacionamento
UsersTenantsRoles utr = UsersTenantsRoles.of(user, tenant, role);
usersTenantsRolesRepository.save(utr);

// Agora Jo√£o √© EDITOR na Empresa XYZ
```

### Exemplo 3: Permission com Policy ABAC

```java
// 1. Criar policy
Policy policy = Policy.createNew(
    "Time-Based Edit Policy",
    "Permite edi√ß√£o apenas durante hor√°rio comercial",
    PolicyEffect.ALLOW,
    List.of("update", "delete"),
    List.of("articles"),
    conditions // JSON com regras
);
policyRepository.save(policy);

// 2. Associar policy √† permission
Permission updateArticles = permissionRepository.findByActionAndResource("update", "articles");
updateArticles.setPolicy(policy);
permissionRepository.save(updateArticles);
```

### Exemplo 4: Verificar Permiss√µes de um Usu√°rio

```java
// Buscar todas as permissions de um usu√°rio em um tenant espec√≠fico
public Set<Permission> getUserPermissions(UUID userId, UUID tenantId) {
    // 1. Buscar roles do usu√°rio no tenant
    List<UsersTenantsRoles> userTenantRoles = usersTenantsRolesRepository
        .findByUserIdAndTenantId(userId, tenantId);
    
    // 2. Buscar todas as permissions dos roles
    Set<Permission> permissions = new HashSet<>();
    for (UsersTenantsRoles utr : userTenantRoles) {
        Role role = roleRepository.findById(utr.getRoleId()).orElseThrow();
        permissions.addAll(role.getPermissions());
    }
    
    return permissions;
}

// Verificar se usu√°rio pode executar uma a√ß√£o
public boolean canUserPerformAction(UUID userId, UUID tenantId, String action, String resource) {
    Set<Permission> permissions = getUserPermissions(userId, tenantId);
    
    for (Permission permission : permissions) {
        if (permission.getAction().equals(action) && 
            permission.getResource().equals(resource)) {
            
            // Se tem policy, avaliar condi√ß√µes
            if (permission.hasPolicy()) {
                return evaluatePolicy(permission.getPolicy(), userId, tenantId);
            }
            
            return true; // Sem policy, permite
        }
    }
    
    return false; // N√£o tem permiss√£o
}
```

## üîê Regras de Neg√≥cio

### Multi-Tenancy
1. ‚úÖ Um tenant pode ter m√∫ltiplas roles
2. ‚úÖ Roles s√£o espec√≠ficas por tenant (mesmo nome pode existir em tenants diferentes)
3. ‚úÖ Um usu√°rio pode participar de m√∫ltiplos tenants
4. ‚úÖ Um usu√°rio pode ter m√∫ltiplos roles no mesmo tenant
5. ‚úÖ Isolamento total de dados entre tenants

### RBAC (Role-Based Access Control)
1. ‚úÖ Um role pertence a um √∫nico tenant
2. ‚úÖ Um role pode ter m√∫ltiplas permissions
3. ‚úÖ Uma permission pode estar em m√∫ltiplos roles
4. ‚úÖ Permissions s√£o globais (compartilhadas entre tenants)

### ABAC (Attribute-Based Access Control)
1. ‚úÖ Uma permission pode ter uma policy associada
2. ‚úÖ Uma policy pode ser usada por m√∫ltiplas permissions
3. ‚úÖ Policy define condi√ß√µes adicionais (IP, hor√°rio, atributos, etc.)
4. ‚úÖ Policy pode ALLOW ou DENY acesso

### Hierarquia de Decis√£o
```
1. Usu√°rio tem role no tenant? 
   ‚îî‚îÄ> N√ÉO: DENY
   ‚îî‚îÄ> SIM: Continue

2. Role tem a permission necess√°ria?
   ‚îî‚îÄ> N√ÉO: DENY
   ‚îî‚îÄ> SIM: Continue

3. Permission tem policy associada?
   ‚îî‚îÄ> N√ÉO: ALLOW (apenas RBAC)
   ‚îî‚îÄ> SIM: Continue

4. Policy permite acesso? (avaliar condi√ß√µes)
   ‚îî‚îÄ> DENY: DENY
   ‚îî‚îÄ> ALLOW: ALLOW
```

## üé® Casos de Uso Comuns

### Caso 1: Sistema SaaS Multi-Empresa
```
Tenant: "Empresa A"
  ‚îú‚îÄ Role: ADMIN (todas permissions)
  ‚îú‚îÄ Role: MANAGER (create, read, update)
  ‚îî‚îÄ Role: USER (read)

Tenant: "Empresa B"
  ‚îú‚îÄ Role: SUPER_ADMIN (todas permissions + admin features)
  ‚îú‚îÄ Role: TEAM_LEAD (create, read, update projects)
  ‚îî‚îÄ Role: DEVELOPER (read, update tasks)

User: Jo√£o
  ‚îú‚îÄ Empresa A: MANAGER
  ‚îî‚îÄ Empresa B: DEVELOPER
```

### Caso 2: Sistema Corporativo com Departamentos
```
Tenant: "Corpora√ß√£o XYZ"
  ‚îú‚îÄ Role: HR_ADMIN (permissions em employees)
  ‚îú‚îÄ Role: FINANCE_ADMIN (permissions em invoices)
  ‚îî‚îÄ Role: IT_ADMIN (permissions em systems)

Permissions com Policies:
  ‚îú‚îÄ delete:employees ‚Üí Policy: "Apenas durante expediente + aprova√ß√£o gerente"
  ‚îú‚îÄ approve:invoices ‚Üí Policy: "Valor < $10k OU tem role FINANCE_DIRECTOR"
  ‚îî‚îÄ access:systems ‚Üí Policy: "IP interno + VPN ativa"
```

## üìà Performance e Otimiza√ß√£o

### √çndices Recomendados
```sql
-- Roles
CREATE INDEX idx_roles_tenant_id ON roles(tenant_id);
CREATE INDEX idx_roles_name_tenant ON roles(name, tenant_id);

-- Permissions
CREATE INDEX idx_permissions_action ON permissions(action);
CREATE INDEX idx_permissions_resource ON permissions(resource);
CREATE INDEX idx_permissions_policy_id ON permissions(policy_id);

-- UsersTenantsRoles
CREATE INDEX idx_utr_user_tenant ON users_tenants_roles(user_id, tenant_id);
CREATE INDEX idx_utr_tenant_role ON users_tenants_roles(tenant_id, role_id);

-- Roles_Permissions (tabela de jun√ß√£o JPA)
CREATE INDEX idx_rp_role_id ON roles_permissions(role_id);
CREATE INDEX idx_rp_permission_id ON roles_permissions(permission_id);
```

### Cache Estrat√©gico
```java
// Cachear permissions de usu√°rios por tenant
@Cacheable(value = "user-permissions", key = "#userId + '-' + #tenantId")
public Set<Permission> getUserPermissions(UUID userId, UUID tenantId) { ... }

// Cachear roles de tenant
@Cacheable(value = "tenant-roles", key = "#tenantId")
public List<Role> getTenantRoles(UUID tenantId) { ... }
```

## üöÄ Migra√ß√£o do Modelo Antigo

Se voc√™ tinha um modelo diferente, o Hibernate ir√°:
1. Adicionar coluna `tenant_id` na tabela `roles`
2. Adicionar coluna `policy_id` na tabela `permissions`
3. Manter tabela `roles_permissions` (gerenciada pelo JPA)
4. Manter tabela `users_tenants_roles`

**Aten√ß√£o:** Roles existentes precisar√£o ser associados a um tenant!

---

**√öltima atualiza√ß√£o:** 04/10/2025
**Vers√£o:** 2.0
**Status:** ‚úÖ Implementado

